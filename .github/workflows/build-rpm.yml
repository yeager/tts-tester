name: Build RPM

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install build dependencies
        run: |
          dnf update -y
          dnf install -y \
            rpm-build rpmdevtools \
            python3-devel python3-setuptools \
            desktop-file-utils gettext
      
      - name: Set up RPM build environment
        run: |
          rpmdev-setuptree
          
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="0.1.0"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      
      - name: Create RPM spec and build
        run: |
          cat > ~/rpmbuild/SPECS/tts-tester.spec << 'SPEC'
          Name:           tts-tester
          Version:        VERSION_PLACEHOLDER
          Release:        1
          Summary:        Text-to-speech engine comparison tool
          
          License:        GPL-3.0-or-later
          URL:            https://github.com/yeager/tts-tester
          Source0:        %{name}-%{version}.tar.gz
          
          BuildArch:      noarch
          BuildRequires:  python3-devel python3-setuptools desktop-file-utils gettext
          Requires:       python3-gobject gtk4 libadwaita
          
          %description
          TTS Tester is a GTK4/Libadwaita application for comparing TTS engines.
          
          %prep
          %setup -q
          
          %build
          %py3_build
          
          %install
          %py3_install
          
          mkdir -p %{buildroot}%{_datadir}/applications
          desktop-file-install --dir=%{buildroot}%{_datadir}/applications data/se.danielnylander.tts-tester.desktop
          
          mkdir -p %{buildroot}%{_datadir}/icons/hicolor/scalable/apps
          cp data/icons/se.danielnylander.tts-tester.svg %{buildroot}%{_datadir}/icons/hicolor/scalable/apps/
          
          %files
          %license LICENSE
          %doc README.md
          %{python3_sitelib}/tts_tester/
          %{python3_sitelib}/tts_tester-*.egg-info/
          %{_bindir}/tts-tester
          %{_datadir}/applications/se.danielnylander.tts-tester.desktop
          %{_datadir}/icons/hicolor/scalable/apps/se.danielnylander.tts-tester.svg
          
          %changelog
          SPEC
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" ~/rpmbuild/SPECS/tts-tester.spec
          echo "          * $(date '+%a %b %d %Y') Daniel Nylander <daniel@danielnylander.se> - $VERSION-1" >> ~/rpmbuild/SPECS/tts-tester.spec
          echo "          - New upstream release" >> ~/rpmbuild/SPECS/tts-tester.spec
          
          sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" src/tts_tester/__init__.py
          
          tar czf ~/rpmbuild/SOURCES/tts-tester-$VERSION.tar.gz \
            --transform "s,^,tts-tester-$VERSION/," \
            --exclude='.git*' --exclude='*.pyc' --exclude='__pycache__' \
            *
          
          rpmbuild -ba ~/rpmbuild/SPECS/tts-tester.spec
      
      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v3
        with:
          name: rpm-packages
          path: |
            ~/rpmbuild/RPMS/noarch/*.rpm
            ~/rpmbuild/SRPMS/*.rpm
