name: Build RPM

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install build dependencies
        run: |
          dnf update -y
          dnf install -y \
            rpm-build rpmdevtools \
            python3-devel python3-setuptools \
            desktop-file-utils gettext
      
      - name: Set up RPM build environment
        run: |
          rpmdev-setuptree
          
          # Extract version
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="0.1.0"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      
      - name: Create RPM spec file
        run: |
          cat > ~/rpmbuild/SPECS/ha-l10n.spec << EOF
          Name:           ha-l10n
          Version:        $VERSION
          Release:        1%{?dist}
          Summary:        Home Assistant translation status dashboard
          
          License:        GPL-3.0-or-later
          URL:            https://github.com/yeager/ha-l10n
          Source0:        %{name}-%{version}.tar.gz
          
          BuildArch:      noarch
          BuildRequires:  python3-devel python3-setuptools desktop-file-utils gettext
          Requires:       python3-gobject gtk4 libadwaita python3-requests
          
          %description
          Home Assistant L10n is a GTK4/Libadwaita application that provides
          a dashboard for monitoring Home Assistant translation status across
          different languages.
          
          %prep
          %setup -q
          
          %build
          %py3_build
          
          %install
          %py3_install
          
          # Install desktop file
          mkdir -p %{buildroot}%{_datadir}/applications
          desktop-file-install --dir=%{buildroot}%{_datadir}/applications data/se.danielnylander.ha-l10n.desktop
          
          # Install icon
          mkdir -p %{buildroot}%{_datadir}/icons/hicolor/scalable/apps
          cp data/icons/se.danielnylander.ha-l10n.svg %{buildroot}%{_datadir}/icons/hicolor/scalable/apps/
          
          # Install man page
          mkdir -p %{buildroot}%{_mandir}/man1
          cp data/man/ha-l10n.1 %{buildroot}%{_mandir}/man1/
          
          %files
          %license LICENSE
          %doc README.md
          %{python3_sitelib}/ha_l10n/
          %{python3_sitelib}/ha_l10n-*.egg-info/
          %{_bindir}/ha-l10n
          %{_datadir}/applications/se.danielnylander.ha-l10n.desktop
          %{_datadir}/icons/hicolor/scalable/apps/se.danielnylander.ha-l10n.svg
          %{_mandir}/man1/ha-l10n.1*
          
          %changelog
          * $(date '+%a %b %d %Y') Daniel Nylander <daniel@danielnylander.se> - $VERSION-1
          - New upstream release
          EOF
      
      - name: Create source tarball
        run: |
          # Update version in source
          sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" src/ha_l10n/__init__.py
          
          # Create tarball
          tar czf ~/rpmbuild/SOURCES/ha-l10n-$VERSION.tar.gz \
            --transform "s,^,ha-l10n-$VERSION/," \
            --exclude='.git*' --exclude='*.pyc' --exclude='__pycache__' \
            *
      
      - name: Build RPM
        run: |
          rpmbuild -ba ~/rpmbuild/SPECS/ha-l10n.spec
      
      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v3
        with:
          name: rpm-packages
          path: |
            ~/rpmbuild/RPMS/noarch/*.rpm
            ~/rpmbuild/SRPMS/*.rpm