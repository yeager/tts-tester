name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            devscripts debhelper-compat \
            dh-python python3-all python3-setuptools \
            gettext desktop-file-utils
      
      - name: Prepare source
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # Update version in __init__.py
          sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" src/ha_l10n/__init__.py
          
          # Create source tarball
          python -m build --sdist
      
      - name: Build Debian package
        run: |
          # Create debian directory structure
          mkdir -p debian/source
          
          # Create control file
          cat > debian/control << EOF
          Source: ha-l10n
          Section: utils
          Priority: optional
          Maintainer: Daniel Nylander <daniel@danielnylander.se>
          Build-Depends: debhelper-compat (= 13),
                        dh-python,
                        python3-all,
                        python3-setuptools,
                        gettext,
                        desktop-file-utils
          Standards-Version: 4.6.1
          Homepage: https://github.com/yeager/ha-l10n
          Vcs-Git: https://github.com/yeager/ha-l10n.git
          Vcs-Browser: https://github.com/yeager/ha-l10n
          
          Package: ha-l10n
          Architecture: all
          Depends: \${python3:Depends}, \${misc:Depends},
                   python3-gi,
                   gir1.2-gtk-4.0,
                   gir1.2-adw-1,
                   python3-requests
          Description: Home Assistant translation status dashboard
           Home Assistant L10n is a GTK4/Libadwaita application that provides
           a dashboard for monitoring Home Assistant translation status across
           different languages.
          EOF
          
          # Create other debian files
          echo "13" > debian/compat
          echo "3.0 (quilt)" > debian/source/format
          
          cat > debian/rules << 'EOF'
          #!/usr/bin/make -f
          
          %:
          	dh $@ --with python3 --buildsystem=pybuild
          
          override_dh_auto_install:
          	dh_auto_install
          	# Install desktop file
          	mkdir -p debian/ha-l10n/usr/share/applications
          	desktop-file-install --dir=debian/ha-l10n/usr/share/applications data/se.danielnylander.ha-l10n.desktop
          	# Install icon
          	mkdir -p debian/ha-l10n/usr/share/icons/hicolor/scalable/apps
          	cp data/icons/se.danielnylander.ha-l10n.svg debian/ha-l10n/usr/share/icons/hicolor/scalable/apps/
          	# Install man page
          	mkdir -p debian/ha-l10n/usr/share/man/man1
          	cp data/man/ha-l10n.1 debian/ha-l10n/usr/share/man/man1/
          EOF
          
          chmod +x debian/rules
          
          cat > debian/changelog << EOF
          ha-l10n ($VERSION-1) unstable; urgency=medium
          
            * New upstream release
          
           -- Daniel Nylander <daniel@danielnylander.se>  $(date -R)
          EOF
          
          # Build package
          dpkg-buildpackage -us -uc
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ../*.deb
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}